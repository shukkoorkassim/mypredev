name: Update TestRail Test Case

on:
  issues:
    types: [closed]

jobs:
  update-testrail:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Update TestRail Test Case
        run: |
          # Set variables
          TESTRAIL_URL="https://ibm.testrail.io"  # Make sure no trailing slash
          TESTRAIL_API_KEY="AgxXL24VaKQXh4AZEbZm-bEbGb2pEQYp90PcrJDlZ"
          TESTRAIL_USERNAME="shukkoor@ibm.com"  # Use a GitHub secret for your username
          TESTRAIL_PROJECT_ID="387"
          TESTRAIL_SUITE_ID="9342"
          TESTRAIL_RUN_ID="133195"
          TESTRAIL_STATUS_ID="1"  # '1' for Passed status
          GITHUB_ISSUE_URL="${{ github.event.issue.html_url }}"

          # Hardcoded Test Case ID for now
          TESTCASE_ID="21852725"
          echo "Updating TestRail Test Case ID: $TESTCASE_ID"

          # Define the authentication
          AUTH="$TESTRAIL_USERNAME:$TESTRAIL_API_KEY"

          # Define the data to send in the request
          DATA="{\"status_id\": $TESTRAIL_STATUS_ID, \"comment\": \"Issue closed in GitHub: $GITHUB_ISSUE_URL\", \"custom_custom_automationid\": \"100\"}"

          # Debugging Output: Print the URL, auth, and data
          echo "URL: $TESTRAIL_URL/index.php?/api/v2/add_result_for_case/$TESTRAIL_RUN_ID/$TESTCASE_ID"
          echo "Auth: $AUTH"
          echo "Data: $DATA"

          # Update TestRail Test Case to 'Passed' (or any other desired status)
          curl -X POST "$TESTRAIL_URL/index.php?/api/v2/add_result_for_case/$TESTRAIL_RUN_ID/$TESTCASE_ID" \
            -u "$AUTH" \  # Use username and API key for authentication
            -H "Content-Type: application/json" \
            -d "$DATA"
